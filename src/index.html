<!DOCTYPE html>
<html>
  <head>
    <title>Feux d'espaces naturels combustibles</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.6/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  </head>
  <body>

    <div class="tabs">
      <button class="tab active" data-tab="donnees">Données</button>
      <button class="tab" data-tab="carte">Carte</button>
    </div>
    
    <div class="tab-content" data-tab="donnees">
      <!-- Contenu de l'onglet "Données" -->
      <div id="data">
        <aside>
          <label for="checkbox1">
            <input type="checkbox" id="checkICL" class="filter"> ICL
          </label>
          <label for="checkbox2">
            <input type="checkbox" id="checkIH" class="filter"> IH
          </label>
          <label for="checkbox3">
            <input type="checkbox" id="checkIS" class="filter"> IS
          </label>
          <label for="checkbox4">
            <input type="checkbox" id="checkIEPx" class="filter"> IEPx
          </label>
          <label for="checkbox5">
            <input type="checkbox" id="checkIFM" class="filter"> IFM
          </label>
          <label for="checkbox6">
            <input type="checkbox" id="checkNSV2" class="filter"> NSV2
          </label>
          <label for="checkbox7">
            <input type="checkbox" id="checkIDI" class="filter"> IDI
          </label>
          <button class="export-button" onclick="exporter()">Exporter</button>
        </aside>
      
        <section>
          <table class="styled-table">
            <thead>
              <tr>
                <th></th>
                <th>Grésigne</th>
                <th>Ségala</th>
                <th>Cogagne</th>
                <th>Sidobre</th>
                <th>Castrais</th>
                <th>Haut Languedoc</th>
                <th>Montagne Noire</th>
              </tr>
            </thead>
            <tbody>
              <tr class="data-row">
                <th>ICL</th>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
              </tr>
              <tr class="data-row">
                <th>IH</th>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
              </tr>
              <tr class="data-row">
                <th>IS</th>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
                <td name="IDS">4000</td>
              </tr>
              <tr class="data-row">
                <th>IEPx</th>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
              </tr>
              <tr class="data-row">
                <th>IFM</th>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
                <td name="IDD">5000</td>
              </tr>
              <tr class="data-row">
                <th>NSV2</th>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
              </tr>
              <tr class="data-row">
                <th>IDI</th>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
                <td name="IDR">6000</td>
              </tr>
              <tr class="data-row">
                <th>Température de chaussée</th>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
              </tr>
              <tr class="data-row">
                <th>Force du vent</th>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
              </tr>
              <tr class="data-row">
                <th>Taux d'humidité</th>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
              </tr>
              <tr class="data-row">
                <th>Nébulosité</th>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
                <td name="conditions">10</td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>
    </div>
    
    <div class="tab-content" data-tab="carte" style="display: none;">
      <!-- Contenu de l'onglet "Carte" -->
      <div id="map">
        <aside>
          <label for="checkbox1">
            <input type="checkbox" id="checkbox1"> Checkbox 4
          </label>
          <label for="checkbox2">
            <input type="checkbox" id="checkbox2"> Checkbox 5
          </label>
          <label for="checkbox3">
            <input type="checkbox" id="checkbox3"> Checkbox 6
          </label>
        </aside>
      
        <section>
          <div id="mapid"></div>
          
        </section>
      </div>
    </div>

    <script>
      /*--------------------------------------------------------------------------Changement d'onglets--------------------------------------------------------------------------*/

      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');

          tabs.forEach(tab => {
            tab.classList.remove('active');
          });

          tabContents.forEach(content => {
            content.style.display = 'none';
          });

          tab.classList.add('active');
          document.querySelector(`.tab-content[data-tab="${tabId}"]`).style.display = 'inline-block';
        });
      });

      /*--------------------------------------------------------------------------Checkbox change tab--------------------------------------------------------------------------*/

      const filters = document.querySelectorAll('.filter');
      const rows = document.querySelectorAll('.data-row');

      filters.forEach(filter => {
        filter.addEventListener("change", () => {
          filterRows();
        });
      });

      function filterRows() {
        const selectedFilters = Array.from(document.querySelectorAll('.filter:checked')).map(filter => filter.id.replace('check', ''));
        const rows = document.querySelectorAll('.data-row');

        // Si aucun filtre n'est sélectionné, afficher toutes les lignes
        if (selectedFilters.length === 0) {
          rows.forEach(row => {
            row.style.display = "table-row";
          });
          return;
        }

        rows.forEach(row => {
          const rowValues = Array.from(row.querySelectorAll('th')).map(cell => cell.innerText);
          let matchCount = 0;

          selectedFilters.forEach(filter => {
            if (rowValues.includes(filter)) {
              matchCount++;
            }
          });

          if (matchCount > 0) {
            row.style.display = "table-row";
          } else {
            row.style.display = "none";
          }
        });
      }

      /*--------------------------------------------------------------------------Exportation--------------------------------------------------------------------------*/

      // Récupère les données HTML de la page et les formate en un tableau
      function getConditions() {
        const elements = document.querySelectorAll("td[name='conditions']");
        const data = [];
        elements.forEach(element => {
          data.push([element.textContent]);
        });
        return data;
      }

      function getIDS() {
        const elements = document.querySelectorAll("td[name='IDS']");
        const data = [];
        elements.forEach(element => {
          data.push([element.textContent]);
        });
        return data;
      }

      function getIDD() {
        const elements = document.querySelectorAll("td[name='IDD']");
        const data = [];
        elements.forEach(element => {
          data.push([element.textContent]);
        });
        return data;
      }

      function getIDR() {
        const elements = document.querySelectorAll("td[name='IDR']");
        const data = [];
        elements.forEach(element => {
          data.push([element.textContent]);
        });
        return data;
      }

      // Fonction d'exportation
      function exporter() {        
        // Création d'une nouvelle feuille Excel
        var feuille = XLSX.utils.aoa_to_sheet([[]]);
        var classeur = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(classeur, feuille, 'Feuille 1');

        // Formatage de la feuille Excel
        // Fusion des cellules pour les titres
        feuille['!merges'] = [{s: {r: 1, c: 0}, e: {r: 2, c: 1}}, //A2:B3
                              {s: {r: 3, c: 0}, e: {r: 5, c: 1}}, //A4:B6
                              {s: {r: 6, c: 0}, e: {r: 7, c: 1}}, //A7:B9
                              {s: {r: 8, c: 0}, e: {r: 9, c: 1}}, //A9:B10
                              {s: {r: 10, c: 0}, e: {r: 10, c: 2}}, //A11:C11

                              {s: {r: 11, c: 0}, e: {r: 31, c: 0}}, //A12:A32
                              {s: {r: 11, c: 1}, e: {r: 17, c: 1}}, //B12:B18 
                              {s: {r: 18, c: 1}, e: {r: 24, c: 1}}, //B19:B25
                              {s: {r: 25, c: 1}, e: {r: 31, c: 1}}, //B26:B32

                              {s: {r: 32, c: 0}, e: {r: 59, c: 0}}, //A33:A60
                              {s: {r: 32, c: 1}, e: {r: 38, c: 1}}, //B33:B39
                              {s: {r: 39, c: 1}, e: {r: 45, c: 1}}, //B39:B46
                              {s: {r: 46, c: 1}, e: {r: 52, c: 1}}, //B47:B53
                              {s: {r: 53, c: 1}, e: {r: 59, c: 1}}, //B54:B60
                            ];

        
        //XLSX.utils.sheet_add_aoa(feuille, 'A1', { t: 's', v: 'Name', s: { font: { blod: 'true' } } });
        //XLSX.utils.sheet_add_aoa(feuille, [["Température (max)"]], { t: 's', v: 'Name', s: { font: { blod: 'true' } } , origin: "A2", skipHeader: true,});

        XLSX.utils.sheet_add_aoa(feuille, [["Température (max)"]], {origin: "A2", skipHeader: true,});
        XLSX.utils.sheet_add_aoa(feuille, [["Vent"]], {origin: "A4"});
        XLSX.utils.sheet_add_aoa(feuille, [["Humidité (%)"]], {origin: "A7"});
        XLSX.utils.sheet_add_aoa(feuille, [["Nébulosité (%)"]], {origin: "A9"});
        XLSX.utils.sheet_add_aoa(feuille, [["Pluie (mm)"]], {origin: "A11"});

        XLSX.utils.sheet_add_aoa(feuille, [["Indices de sécheresse"]], {origin: "A12"});
        XLSX.utils.sheet_add_aoa(feuille, [["Indicateurs de risques"]], {origin: "A33"});

        XLSX.utils.sheet_add_aoa(feuille, [["Air (°C)"], ["Chaussée (°C)"], ["Orientation"], ["Vitesse (kh/h)"], ["Rafales (km/h)"],
                                            ["08h00"], ["17h00"],["08h00"], ["17h00"]], {origin: "C2", skipHeader: true,});

        XLSX.utils.sheet_add_aoa(feuille, [["ICLx"]], {origin: "B12"});
        XLSX.utils.sheet_add_aoa(feuille, [["IH"]], {origin: "B19"});
        XLSX.utils.sheet_add_aoa(feuille, [["IS"]], {origin: "B26"});
        XLSX.utils.sheet_add_aoa(feuille, [["IEPx"]], {origin: "B33"});
        XLSX.utils.sheet_add_aoa(feuille, [["IFM"]], {origin: "B40"});
        XLSX.utils.sheet_add_aoa(feuille, [["NSV2"]], {origin: "B47"});
        XLSX.utils.sheet_add_aoa(feuille, [["IDI"]], {origin: "B54"});
        
        /*var data = getConditions();
        XLSX.utils.sheet_add_aoa(feuille, data, {origin: "D2", skipHeader: true,});*/
        var data = getIDS();
        XLSX.utils.sheet_add_aoa(feuille, data, {origin: "D12", skipHeader: true,});
        var data = getIDD();
        XLSX.utils.sheet_add_aoa(feuille, data, {origin: "D33", skipHeader: true,});
        var data = getIDR();
        XLSX.utils.sheet_add_aoa(feuille, data, {origin: "D47", skipHeader: true,});

        // Exportation de la feuille Excel
        XLSX.writeFile(classeur, 'indices.xlsx');
      }

    </script>

  </body>
</html>
